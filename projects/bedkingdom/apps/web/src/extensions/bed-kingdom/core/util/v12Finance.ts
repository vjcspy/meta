import moment from 'moment/moment';

export const settings = {
  retailerId: 2614,
  retailerGuid: 'f395e7c5-86b6-427c-9004-9d57bc1c24c3',
  applicationUrl:
    'https://apply.v12finance.com/javascriptgateway/retailer-scripts/2614/f395e7c5-86b6-427c-9004-9d57bc1c24c3/submitusingformpost',
  version: '1.0.9',
};
export const financeProducts = [
  {
    productId: 108,
    productGuid: '7abb2574-a59b-42f9-a33f-1f3c00459473',
    name: 'Interest Free Finance (3 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 3,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFF3',
    altTag: 'ONIF3',
    settlementFee: 0.0,
  },
  {
    productId: 27,
    productGuid: '244b3e7a-0ffb-41f2-88d5-adf78b6a3d9e',
    name: 'Interest Free Finance (6 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 6,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFF6',
    altTag: 'ONIF6',
    settlementFee: 0.0,
  },
  {
    productId: 43,
    productGuid: '20125e19-f2c2-42f4-a230-ec668f776296',
    name: 'Interest Free Finance (9 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 9,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFF9',
    altTag: 'ONIF9',
    settlementFee: 0.0,
  },
  {
    productId: 88,
    productGuid: '34ee414c-94d8-4cd2-8f62-fc5b8a2d2a7d',
    name: 'Interest Free Finance (10 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 10,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFC-10',
    altTag: 'ONIF10',
    settlementFee: 0.0,
  },
  {
    productId: 28,
    productGuid: '8e0bd3a9-657f-457c-b488-dbfab37fac39',
    name: 'Interest Free Finance (12 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 12,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFF12',
    altTag: 'ONIF12',
    settlementFee: 0.0,
  },
  {
    productId: 46,
    productGuid: 'c3114266-125a-4ea1-ab10-cfb3ebd48b81',
    name: 'Interest Free Finance (18 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 18,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFF18',
    altTag: 'ONIF18',
    settlementFee: 0.0,
  },
  {
    productId: 124,
    productGuid: '9c5bf525-f886-4a4a-8eaf-04a4d8d2d82d',
    name: 'Interest Free Finance (20 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 20,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFF20',
    altTag: 'ONIF20',
    settlementFee: 0.0,
  },
  {
    productId: 29,
    productGuid: '9d6fa148-eeb2-4345-b5c6-961902a8f0eb',
    name: 'Interest Free Finance (24 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 24,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFF24',
    altTag: 'ONIF24',
    settlementFee: 0.0,
  },
  {
    productId: 56,
    productGuid: '1037063d-fdc4-46e6-a448-5df512a96c00',
    name: 'Interest Free Finance (30 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 30,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFF30',
    altTag: 'ONIF30',
    settlementFee: 0.0,
  },
  {
    productId: 30,
    productGuid: 'e931ab43-b8ae-431d-ac50-812d413fb5bb',
    name: 'Interest Free Finance (36 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 36,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFF36',
    altTag: 'ONIF36',
    settlementFee: 0.0,
  },
  {
    productId: 67,
    productGuid: '66816e03-f2fc-4497-b70d-4985cbaf6093',
    name: 'Interest Free Finance (42 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 42,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFF42',
    altTag: 'ONIF42',
    settlementFee: 0.0,
  },
  {
    productId: 31,
    productGuid: 'e2d7b26b-d494-494a-aa50-a804c52942a0',
    name: 'Interest Free Finance (48 Months)',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 48,
    monthlyRate: 0.0,
    apr: 0.0,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'IFF48',
    altTag: 'ONIF48',
    settlementFee: 0.0,
  },
  {
    productId: 153,
    productGuid: 'b6d3e8f9-a90e-4295-b7bc-f169b0b018bd',
    name: 'Classic Credit 12 months 7.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 12,
    monthlyRate: 0.635,
    apr: 7.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC12-7.9',
    altTag: 'ONIB12-7.9',
    settlementFee: 0.0,
  },
  {
    productId: 155,
    productGuid: '5b9a0f59-70af-40e7-8536-a048b256840f',
    name: 'Classic Credit 24 months 7.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 24,
    monthlyRate: 0.635,
    apr: 7.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC24-7.9',
    altTag: 'ONIB24-7.9',
    settlementFee: 0.0,
  },
  {
    productId: 156,
    productGuid: '8f261393-5434-4392-89df-de7f6539d014',
    name: 'Classic Credit 36 months 7.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 36,
    monthlyRate: 0.635,
    apr: 7.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC36-7.9',
    altTag: 'ONIB36-7.9',
    settlementFee: 0.0,
  },
  {
    productId: 158,
    productGuid: '311c15ef-7ada-4e23-a6e7-c0c53cf3ad6c',
    name: 'Classic Credit 48 months 7.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 48,
    monthlyRate: 0.635,
    apr: 7.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC48-7.9',
    altTag: 'ONIB48-7.9',
    settlementFee: 0.0,
  },
  {
    productId: 159,
    productGuid: '37849592-94b8-452f-9e69-a2f62d8fbde5',
    name: 'Classic Credit 60 months 7.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 60,
    monthlyRate: 0.635,
    apr: 7.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC60-7.9',
    altTag: 'ONIB60-7.9',
    settlementFee: 0.0,
  },
  {
    productId: 162,
    productGuid: '46aff7e0-910c-4f4d-8d36-4bc3e2a84dad',
    name: 'Classic Credit 12 months 9.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 12,
    monthlyRate: 0.789,
    apr: 9.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC12-9.9',
    altTag: 'ONIB12-9.9',
    settlementFee: 0.0,
  },
  {
    productId: 54,
    productGuid: '152fea32-be31-4b73-94d9-f23716c42aac',
    name: 'Classic Credit 24 Months 9.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 24,
    monthlyRate: 0.79,
    apr: 9.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC24-9.9',
    altTag: 'ONIB24-9.9',
    settlementFee: 0.0,
  },
  {
    productId: 44,
    productGuid: 'cc62bb86-f91b-4a85-97eb-94bb7ac4462f',
    name: 'Classic Credit 36 Months 9.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 36,
    monthlyRate: 0.79,
    apr: 9.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC36-9.9',
    altTag: 'ONIB36-9.9',
    settlementFee: 0.0,
  },
  {
    productId: 45,
    productGuid: '5c0da208-597b-4dc8-9e42-2326601fa699',
    name: 'Classic Credit 48 Months 9.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 48,
    monthlyRate: 0.79,
    apr: 9.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC48-9.9',
    altTag: 'ONIB48-9.9',
    settlementFee: 0.0,
  },
  {
    productId: 165,
    productGuid: '131d544f-d03e-4a7f-a4ec-b8c2c080a281',
    name: 'Classic Credit 60 months 9.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 60,
    monthlyRate: 0.789,
    apr: 9.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC60-9.9',
    altTag: 'ONIB60-9.9',
    settlementFee: 0.0,
  },
  {
    productId: 112,
    productGuid: 'bed9d208-d9c1-4d8e-a29f-decb53fd0b22',
    name: 'Classic Credit 12 Months 15.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 12,
    monthlyRate: 1.237,
    apr: 15.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC12-15.9',
    altTag: 'ONIB12-15.9',
    settlementFee: 0.0,
  },
  {
    productId: 64,
    productGuid: '1401bd54-9a22-4ce7-8f7c-61a3ebb93639',
    name: 'Classic Credit 24 Months 15.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 24,
    monthlyRate: 1.237,
    apr: 15.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC24-15.9',
    altTag: 'ONIB24-15.9',
    settlementFee: 0.0,
  },
  {
    productId: 65,
    productGuid: 'bbe76da6-c60e-4881-83fc-328e415f0a5a',
    name: 'Classic Credit 36 Months 15.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 36,
    monthlyRate: 1.237,
    apr: 15.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC36-15.9',
    altTag: 'ONIB36-15.9',
    settlementFee: 0.0,
  },
  {
    productId: 66,
    productGuid: '3fd9bcde-bc26-47d2-bd4f-df453bc6f1a1',
    name: 'Classic Credit 48 Months 15.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 48,
    monthlyRate: 1.237,
    apr: 15.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC48-15.9',
    altTag: 'ONIB48-15.9',
    settlementFee: 0.0,
  },
  {
    productId: 179,
    productGuid: '20f64eb0-897c-417d-a6ce-8ec3167a603c',
    name: 'Classic Credit 60 months 15.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 60,
    monthlyRate: 1.237,
    apr: 15.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC60-15.9',
    altTag: 'ONIB60-15.9',
    settlementFee: 0.0,
  },
  {
    productId: 16,
    productGuid: 'eaa79f8c-7e34-4271-9df0-05e31799e90f',
    name: 'Classic Credit 12 Months 19.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 12,
    monthlyRate: 1.524,
    apr: 19.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC12-19.9',
    altTag: 'ONIB12-19.9',
    settlementFee: 0.0,
  },
  {
    productId: 17,
    productGuid: '69f15799-5fc9-496d-925d-622958acd83d',
    name: 'Classic Credit 24 Months 19.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 24,
    monthlyRate: 1.524,
    apr: 19.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC24-19.9',
    altTag: 'ONIB24-19.9',
    settlementFee: 0.0,
  },
  {
    productId: 18,
    productGuid: '8fbcde88-3687-4721-a9d3-6f73f69a6757',
    name: 'Classic Credit 36 Months 19.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 36,
    monthlyRate: 1.524,
    apr: 19.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC36-19.9',
    altTag: 'ONIB36-19.9',
    settlementFee: 0.0,
  },
  {
    productId: 26,
    productGuid: '31a50441-ce76-4520-bb42-5e5b72949fbc',
    name: 'Classic Credit 48 Months 19.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 48,
    monthlyRate: 1.524,
    apr: 19.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC48-19.9',
    altTag: 'ONIB48-19.9',
    settlementFee: 0.0,
  },
  {
    productId: 87,
    productGuid: 'c486c712-a96e-46e3-b480-9a78abbaed86',
    name: 'Classic Credit 60 Months 19.9%',
    minLoan: 250.0,
    maxLoan: 15000.0,
    months: 60,
    monthlyRate: 1.524,
    apr: 19.9,
    serviceFee: 0.0,
    documentFee: 0.0,
    documentFeeCollectionMonth: 0,
    documentFeeMaximum: 0,
    documentFeeMinimum: 0,
    documentFeePercentage: 0.0,
    optionPeriod: 0,
    deferredPeriod: 0,
    tag: 'CC60-19.9',
    altTag: 'ONIB60-19.9',
    settlementFee: 0.0,
  },
];
export const getFinanceProduct = (id: any) => {
  for (let i = 0; i < financeProducts.length; i++) {
    if (
      financeProducts[i].productId == id ||
      financeProducts[i].tag == id ||
      financeProducts[i].altTag == id
    ) {
      return financeProducts[i];
    }
  }
  return null;
};
export const getFinanceProducts = () => {
  return financeProducts;
};
export const calculateApr = (
  loan: any,
  instalment: any,
  deferred: any,
  term: any
) => {
  let result = 0;
  let high = 200;
  let low = 0;
  let n, x, j, q, r, y;
  if (deferred > 1) {
    n = term + deferred + 1;
  } else {
    n = term + 1;
  }
  x = 1;
  let z;
  while (x < 20) {
    result = (high + low) / 2;
    j = parseFloat(String(Math.pow(1.0 + result / 100.0, 1.0 / 12.0)));
    q = parseFloat(String(1.0 / j));
    if (deferred < 1) {
      y = parseFloat(
        String((instalment * (1.0 - Math.pow(q, n))) / (1 - q) - instalment)
      );
      z = parseFloat(String(0.0));
    } else {
      y = parseFloat(
        String((instalment * (1.0 - Math.pow(q, n - 1))) / (1 - q) - instalment)
      );
      z = parseFloat(
        String(
          (instalment * (1.0 - Math.pow(q, deferred))) / (1 - q) - instalment
        )
      );
    }
    if (y - z < loan) {
      high = result;
    } else {
      low = result;
    }
    x++;
  }
  return result;
};
export const sumCashFlows = (months: any, cashflows: any) => {
  let total = 0.0;
  for (let i = 1; i < months; i++) {
    total = parseFloat(String(total + parseFloat(cashflows[i - 1].cashFlows)));
  }
  return total;
};
export const earliestDate = (cashflows: any, months: any) => {
  let earliest = cashflows[0].dataDate;
  for (let i = 1; i < months; i++) {
    if (moment(cashflows[i].dataDate).isBefore(earliest)) {
      earliest = cashflows[i].dataDate;
    }
  }
  return earliest;
};
export const presentValue = (
  cashflows: any,
  irr: any,
  loanTerm: any,
  checkdate: any,
  numdays: any
) => {
  let presValue = 0.0;
  for (let i = 0; i < loanTerm; i++) {
    const cf = parseFloat(cashflows[i].cashFlows);

    const diff = parseFloat(
      // @ts-ignore
      moment(checkdate).diff(cashflows[i].dataDate, 'days')
    );
    presValue += cf / Math.pow(1 + irr, diff) / numdays;
  }
  return presValue;
};
const XIRR = (values: any, dates: any, guess: any) => {
  const irrResult = (values: any, dates: any, rate: any) => {
    const r = rate + 1;
    let result = values[0];
    for (let i = 1; i < values.length; i++) {
      result +=
        values[i] /
        Math.pow(r, moment(dates[i]).diff(moment(dates[0]), 'days') / 365);
    }
    return result;
  };
  const irrResultDeriv = function (values: any, dates: any, rate: any) {
    const r = rate + 1;
    let result = 0;
    for (let i = 1; i < values.length; i++) {
      const frac = moment(dates[i]).diff(moment(dates[0]), 'days') / 365;
      result -= (frac * values[i]) / Math.pow(r, frac + 1);
    }
    return result;
  };
  let positive = false;
  let negative = false;
  for (let i = 0; i < values.length; i++) {
    if (values[i] > 0) positive = true;
    if (values[i] < 0) negative = true;
  }
  if (!positive || !negative) return '#NUM!';
  guess = typeof guess === 'undefined' ? 0.1 : guess;
  let resultRate = guess;
  const epsMax = 1e-10;
  const iterMax = 50;
  let newRate, epsRate, resultValue;
  let iteration = 0;
  let contLoop = true;
  do {
    resultValue = irrResult(values, dates, resultRate);
    newRate =
      resultRate - resultValue / irrResultDeriv(values, dates, resultRate);
    epsRate = Math.abs(newRate - resultRate);
    resultRate = newRate;
    contLoop = epsRate > epsMax && Math.abs(resultValue) > epsMax;
  } while (contLoop && ++iteration < iterMax);
  if (contLoop) return '#NUM!';
  return resultRate;
};
export const calculateAprFromIrr = (
  loan: any,
  monthlyinstalment: any,
  loanTerm: any,
  documentfee: any,
  documentfeecollectionmonth: any
) => {
  const startDate = new Date();
  const incomeTable = [];
  const dateTable = [];
  let checkDate;
  const incomeObject = { cashFlows: 0, dataDate: 0 };
  let irr, irrPrev, presentValuePrev, pv;
  if (documentfeecollectionmonth == 0) {
    incomeTable.push(loan * -1 + documentfee);
  } else {
    incomeTable.push(loan * -1);
  }
  dateTable.push(startDate);
  for (let i = 1; i <= loanTerm; i++) {
    const nextDate = moment(startDate).add('M', i);
    dateTable.push(nextDate);
    if (i - 1 == documentfeecollectionmonth && documentfeecollectionmonth > 0) {
      incomeTable.push(parseFloat(monthlyinstalment + documentfee));
    } else {
      incomeTable.push(parseFloat(monthlyinstalment));
    }
  }
  const r = XIRR(incomeTable, dateTable, 0.1);
  return Math.round(r * 10000) / 100;
};

export const calculate = (
  financeProduct: any,
  cashPrice: any,
  deposit: any
) => {
  const apr = parseFloat(financeProduct?.apr);
  const monthlyrate = parseFloat(financeProduct?.monthlyRate);
  let calculatedApr;
  const months = parseFloat(financeProduct?.months);
  const serviceFee = parseFloat(financeProduct?.serviceFee);
  let balancePayable = 0.0;
  let documentFee = 0;
  cashPrice = parseFloat(cashPrice);
  deposit = parseFloat(deposit);
  const loanAmount = cashPrice - deposit;
  let initialPayments, finalPayment;
  balancePayable = loanAmount;
  documentFee =
    financeProduct?.documentFee +
    loanAmount * financeProduct?.documentFeePercentage;
  if (
    financeProduct?.documentFeeMinimum > 0 &&
    documentFee < financeProduct?.documentFeeMinimum
  ) {
    documentFee = financeProduct?.documentFeeMinimum;
  }
  if (
    financeProduct?.documentFeeMaximum > 0 &&
    documentFee > financeProduct?.documentFeeMaximum
  ) {
    documentFee = financeProduct?.documentFeeMaximum;
  }
  if (monthlyrate == 0) {
    initialPayments = Math.round((loanAmount / months) * 100) / 100;
    if (initialPayments * months < loanAmount) {
      initialPayments += 0.01;
    }
    finalPayment = loanAmount - initialPayments * (months - 1);
    calculatedApr = 0;
  } else {
    const yields = Math.pow(apr / 100 + 1, 1.0 / 12);
    let pv = loanAmount - serviceFee;
    if (financeProduct?.deferredPeriod > 1) {
      pv = pv * Math.pow(yields, financeProduct?.deferredPeriod - 1);
    }
    initialPayments =
      Math.floor(
        (0 - pv / ((Math.pow(yields, 0 - months) - 1) / (yields - 1))) * 100
      ) / 100;
    finalPayment = initialPayments;
    balancePayable = initialPayments * months;
    calculatedApr = calculateApr(
      loanAmount - financeProduct?.serviceFee,
      initialPayments,
      financeProduct?.deferredPeriod,
      months
    );
  }
  if (documentFee > 0) {
    calculatedApr = calculateAprFromIrr(
      loanAmount,
      initialPayments,
      months,
      parseFloat(String(documentFee)),
      parseFloat(financeProduct?.documentFeeCollectionMonth)
    );
  }
  let interest = balancePayable - loanAmount;
  const chargeForCredit = interest + serviceFee + documentFee;
  const amountPayable = balancePayable + serviceFee + documentFee + deposit;
  let productAvailable = true;
  let availabilityReason = '';
  if (loanAmount < financeProduct?.minLoan) {
    productAvailable = false;
    availabilityReason =
      'Only available on loan amounts over £' +
      financeProduct?.minLoan.toFixed(2);
  } else if (loanAmount > financeProduct?.maxLoan) {
    productAvailable = false;
    availabilityReason =
      'Only available on loan amounts under £' +
      financeProduct?.maxLoan.toFixed(2);
  }
  interest = initialPayments * months - loanAmount;
  const annualRate =
    ((interest / loanAmount) * 100) /
    ((months + financeProduct?.deferredPeriod) / 12);
  const financeCalculation = {
    initialPayments: initialPayments ?? 0,
    finalPayment: finalPayment.toFixed(2),
    balancePayable: balancePayable.toFixed(2),
    interest: interest.toFixed(2),
    chargeForCredit: chargeForCredit.toFixed(2),
    amountPayable: amountPayable.toFixed(2),
    cashPrice: cashPrice.toFixed(2),
    deposit: deposit.toFixed(2),
    loanAmount: loanAmount.toFixed(2),
    months: months,
    monthsDeferred: financeProduct?.deferredPeriod,
    apr: calculatedApr.toFixed(2),
    productAvailable: productAvailable,
    availabilityReason: availabilityReason,
    productId: financeProduct?.productId,
    productGuid: financeProduct?.productGuid,
    name: financeProduct?.name,
    settlementFee: financeProduct?.settlementFee
      ? financeProduct?.settlementFee.toFixed(2)
      : 0,
    serviceFee: serviceFee.toFixed(2),
    documentFee: documentFee.toFixed(2),
    documentFeeMinimum: financeProduct?.documentFeeMinimum,
    documentFeeMaximum: financeProduct?.documentFeeMaximum,
    documentFeeCollectionMonth: financeProduct?.documentFeeCollectionMonth,
    documentFeePercentage: financeProduct?.documentFeePercentage,
    annualRate: annualRate.toFixed(2),
  };
  return financeCalculation;
};

export const calculateFromProductCode = function (
  productCode: any,
  cashPrice: any,
  deposit: any
) {
  return calculate(getFinanceProduct(productCode), cashPrice, deposit);
};
